(function(ue,de){typeof exports=="object"&&typeof module<"u"?module.exports=de():typeof define=="function"&&define.amd?define(de):(ue=typeof globalThis<"u"?globalThis:ue||self,ue.Vidyn=de())})(this,function(){"use strict";const ue=({dTimestamp:e,playing:t},{trim:s=0,volume:i=1,loop:n=!0,element:r})=>{if(!r)return;r.volume=i;const o=e/1e3+s/1e3;Math.abs(r.currentTime-o)>.5&&(r.currentTime=o),t?window.hasEventDone&&r.paused&&r.play():r.paused||r.pause()},de=e=>e*(Math.PI/180),st=e=>e,V=({ctx:e},t={})=>{if(!t)return;t.x!==void 0&&e.translate(t.x*1,0),t.y!==void 0&&e.translate(0,t.y*1),t.scale!==void 0&&e.scale(t.scale,t.scale),t.scaleX!==void 0&&e.scale(t.scaleX,1),t.scaleY!==void 0&&e.scale(1,t.scaleY),t.angle!==void 0&&e.rotate(de(t.angle)),t.alpha!==void 0&&(e.globalAlpha=t.alpha);let s=[];if(Math.round(t.blur)&&s.push(`blur(${Math.round(t.blur)}px)`),t.brightness!==void 0&&s.push(`brightness(${t.brightness})`),t.contrast!==void 0&&s.push(`contrast(${t.contrast})`),t.grayscale!==void 0&&s.push(`grayscale(${t.grayscale})`),t.hueRotate!==void 0&&s.push(`hue-rotate(${t.hueRotate||0}deg)`),t.saturate!==void 0&&s.push(`saturate(${t.saturate})`),t.sepia!==void 0&&s.push(`sepia(${t.sepia})`),s.length>0&&(e.filter=s.join(" ")),t.lineWidth!==void 0&&(e.lineWidth=t.lineWidth),t.lineCap!==void 0&&(e.lineCap=t.lineCap),t.lineDashOffset!==void 0&&(e.lineDashOffset=t.lineDashOffset),t.lineJoin!==void 0&&(e.lineJoin=t.lineJoin),t.lineDash!==void 0&&e.setLineDash(t.lineDash),t.shadowBlur!==void 0&&(e.shadowBlur=t.shadowBlur),t.shadowColor!==void 0&&(e.shadowColor=t.shadowColor),t.shadowOffsetX!==void 0&&(e.shadowOffsetX=t.shadowOffsetX),t.shadowOffsetY!==void 0&&(e.shadowOffsetY=t.shadowOffsetY),e.fillStyle="rgba(0,0,0,0)",t.fillStyle&&(e.fillStyle=st(t.fillStyle)),e.strokeStyle="rgba(0,0,0,0)",t.strokeStyle&&(e.strokeStyle=st(t.strokeStyle)),t.clip){switch(e.beginPath(),t.clip){case"rectangle":e.roundRect(t.clipX??0,t.clipY??0,t.clipWidth??0,t.clipHeight??0,t.clipRadius??0);break;case"circle":e.moveTo(0,0),e.arc(t.clipX??0,t.clipY??0,t.clipRadius??0,0,t.clipEnd??Math.PI*2);break}e.clip()}};function bt({canvas:e,ctx:t},{width:s,height:i,fit:n="cover",anchorX:r=0,anchorY:o=0,radius:l=0,element:h}){if(!(h!=null&&h.src))return;V({canvas:e,ctx:t},arguments[1]);const c=s/i,v=h.width/h.height,d={sX:0,sY:0,sWidth:h.width,sHeight:h.height,tWidth:s,tHeight:i};switch(n){case"stretch":h.tWidth=s,h.tHeight=i;break;case"fit":h.height/i>h.width/s?(d.tHeight=i,d.tWidth=d.tHeight*v):(d.tWidth=s,d.tHeight=d.tWidth/v),h.tWidth=s,h.tHeight=i;break;case"cover":default:c>v?(d.sWidth=h.width,d.sHeight=h.width/c,d.sY=(h.height-d.sHeight)/2):(d.sHeight=h.height,d.sWidth=h.height*c,d.sX=(h.width-d.sWidth)/2)}t.beginPath(),t.roundRect(-s*r,-i*o,d.tWidth,d.tHeight,l),t.stroke(),t.fill(),t.clip(),t.drawImage(h,d.sX,d.sY,d.sWidth,d.sHeight,-s*r,-i*o,d.tWidth,d.tHeight)}const Mt=e=>new Promise(t=>{const s=()=>{e.seeking===!1&&t(),setTimeout(s,0)};s()});async function kt({canvas:e,ctx:t,dTimestamp:s,playing:i,rendering:n=!1},{width:r,height:o,anchorX:l=.5,anchorY:h=.5,trim:c=0,volume:v=1,fit:d="cover",radius:M=0,element:m}){if(!m)return;V({canvas:e,ctx:t},arguments[1]);const w=r/o,z=m.videoWidth,T=m.videoHeight,I=z/T,C={sX:0,sY:0,sWidth:z,sHeight:T,tWidth:r,tHeight:o};switch(d){case"stretch":m.tWidth=r,m.tHeight=o;break;case"fit":T/o>z/r?(C.tHeight=o,C.tWidth=C.tHeight*I):(C.tWidth=r,C.tHeight=C.tWidth/I),m.tWidth=r,m.tHeight=o;break;case"cover":default:w>I?(C.sWidth=z,C.sHeight=z/w,C.sY=(T-C.sHeight)/2):(C.sHeight=T,C.sWidth=T*w,C.sX=(z-C.sWidth)/2)}m.volume=v;const E=(s/1e3+c/1e3).toFixed(2)*1;n?(m.currentTime=E,await Mt(m)):(Math.abs(m.currentTime-E)>1&&(m.currentTime=E),i?window.hasEventDone&&m.paused&&m.play():m.paused||m.pause()),t.beginPath(),t.roundRect(-r*l,-o*h,C.tWidth,C.tHeight,M),t.stroke(),t.fill(),t.clip(),t.drawImage(m,C.sX,C.sY,C.sWidth,C.sHeight,-r*l,-o*h,C.tWidth,C.tHeight)}const Et=(e=[],t=0)=>{let s={x:0,y:0};return e.forEach((i,n)=>{n==0?(s.x+=(1-t)**3*i.x,s.y+=(1-t)**3*i.y):n==3?(s.x+=t**3*i.x,s.y+=t**3*i.y):(s.x+=3*(1-t)**2*t*i.x,s.y+=3*(1-t)**2*t*i.y)}),s.y},P={clampLeft(e){return 1},clampRight(e){return 0},linear(e){return e},easeInSine(e){return-1*Math.cos(e*(Math.PI/2))+1},easeOutSine(e){return Math.sin(e*(Math.PI/2))},easeInOutSine(e){return-.5*(Math.cos(Math.PI*e)-1)},easeInQuad(e){return e*e},easeOutQuad(e){return e*(2-e)},easeInOutQuad(e){return e<.5?2*e*e:-1+(4-2*e)*e},easeInCubic(e){return e*e*e},easeOutCubic(e){const t=e-1;return t*t*t+1},easeInOutCubic(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},easeInQuart(e){return e*e*e*e},easeOutQuart(e){const t=e-1;return 1-t*t*t*t},easeInOutQuart(e){const t=e-1;return e<.5?8*e*e*e*e:1-8*t*t*t*t},easeInQuint(e){return e*e*e*e*e},easeOutQuint(e){const t=e-1;return 1+t*t*t*t*t},easeInOutQuint(e){const t=e-1;return e<.5?16*e*e*e*e*e:1+16*t*t*t*t*t},easeInExpo(e){return e===0?0:Math.pow(2,10*(e-1))},easeOutExpo(e){return e===1?1:-Math.pow(2,-10*e)+1},easeInOutExpo(e){if(e===0||e===1)return e;const t=e*2,s=t-1;return t<1?.5*Math.pow(2,10*s):.5*(-Math.pow(2,-10*s)+2)},easeInCirc(e){const t=e/1;return-1*(Math.sqrt(1-t*e)-1)},easeOutCirc(e){const t=e-1;return Math.sqrt(1-t*t)},easeInOutCirc(e){const t=e*2,s=t-2;return t<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-s*s)+1)},easeInBack(e,t=1.70158){return e*e*((t+1)*e-t)},easeOutBack(e,t=1.70158){const s=e/1-1;return s*s*((t+1)*s+t)+1},easeInOutBack(e,t=1.70158){const s=e*2,i=s-2,n=t*1.525;return s<1?.5*s*s*((n+1)*s-n):.5*(i*i*((n+1)*i+n)+2)},easeInElastic(e,t=.7){if(e===0||e===1)return e;const i=e/1-1,n=1-t,r=n/(2*Math.PI)*Math.asin(1);return-(Math.pow(2,10*i)*Math.sin((i-r)*(2*Math.PI)/n))},easeOutElastic(e,t=.6){const s=1-t,i=e*2;if(e===0||e===1)return e;const n=s/(2*Math.PI)*Math.asin(1);return Math.pow(2,-10*i)*Math.sin((i-n)*(2*Math.PI)/s)+1},easeInOutElastic(e,t=.65){const s=1-t;if(e===0||e===1)return e;const i=e*2,n=i-1,r=s/(2*Math.PI)*Math.asin(1);return i<1?-.5*(Math.pow(2,10*n)*Math.sin((n-r)*(2*Math.PI)/s)):Math.pow(2,-10*n)*Math.sin((n-r)*(2*Math.PI)/s)*.5+1},easeOutBounce(e){const t=e/1;if(t<1/2.75)return 7.5625*t*t;if(t<2/2.75){const s=t-.5454545454545454;return 7.5625*s*s+.75}else if(t<2.5/2.75){const s=t-.8181818181818182;return 7.5625*s*s+.9375}else{const s=t-.9545454545454546;return 7.5625*s*s+.984375}},easeInBounce(e){return 1-easeOutBounce(1-e)},easeInOutBounce(e){return e<.5?easeInBounce(e*2)*.5:easeOutBounce(e*2-1)*.5+.5}};P.slowdown=P.easeOutExpo,P.accelerate=P.easeInExpo,P.natural=P.easeInOutSine,P.back=P.easeOutBack,P.bounce=P.easeOutBounce,P.elastic=P.easeOutElastic;const _t=e=>{switch(e){case"floor":return t=>Math.floor(t);case"ceil":return t=>Math.ceil(t);case"round":return t=>Math.round(t);default:return t=>t}},We=(e,t=[],s={},i)=>{e-=i.start,e<0&&(e=0);let n={x:0,y:0,scale:1,angle:0,alpha:1,...s};for(let r of t){let{start:o=0,duration:l=1e3,attribute:h,from:c,to:v,easing:d="natural",transform:M,startDelay:m=0}=r;o<0&&i&&(o=i.duration-l);let w={from:c,to:v};for(let B in w)typeof w[B]=="string"&&(w[B].startsWith("+=")?w[B]=s[h]+w[B].substring(2)*1:w[B].startsWith("-=")&&(w[B]=s[h]-w[B].substring(2)*1));let z=e-m;if(z<0&&(z=0),z<o)continue;if(z-m>=o+l){n={...n,[h]:w.to};continue}let T=Math.min(1,Math.max(0,1-(l-(z-o))/l));d&&(Array.isArray(d)&&(T=Et(d,T)),d instanceof Function&&(T=d(T)),typeof d=="string"&&P[d]&&(T=P[d](T)));const I=w.to,C=w.from!=null?w.from:n[h];let E=I-C;n[h]=M?_t(M)(E*T+C):E*T+C}return n};function It({canvas:e,ctx:t,dTimestamp:s},{text:i="",font:n,fontSize:r=10,width:o=null,anchorX:l=.5,anchorY:h=.5,lineHeight:c=1.2,letterSpacing:v=0,lineFill:d},M=[]){V({canvas:e,ctx:t},{...arguments[1]}),i=i+"",t.font=`${r}px ${n&&typeof n=="string"?n.replace(/[0-9.-:\/]*/gm,"")+", ":""}serif`,t.textAlign="left",t.textBaseline="top",t.letterSpacing=`${v}px`;let m=[];i.split(`
`).forEach(C=>m=[...m,...Bt(t,C,o)]);let w={line:0,word:0,letter:0};const T=t.measureText("A").actualBoundingBoxDescent;let I=-(T*c*m.length)*h;m.forEach(C=>{const E=t.measureText(C);let B=-E.width*l;if(t.save(),d){t.fillStyle=d,t.globalAlpha=1,t.beginPath();const U=T*.3;t.roundRect(B-U,I-U,E.width+U*2,T+U*2,[10]),t.fill()}t.restore(),Array.from(C).forEach(H=>{const U=t.measureText(H);t.save(),t.translate(B,I);for(let ie in w){const he=M.filter(Q=>Q.type==ie);let Ae=w[ie],q={};for(let Q of he){let et=Array.isArray(Q.delay)?Q.delay:[Q.delay],Tt=0;for(let tt=0;tt<Ae;tt++)Tt+=et[tt%et.length];q=We(s-Tt,[Q],q,{start:0,duration:1e3})}V({ctx:t},{fillStyle:arguments[1].fillStyle,strokeStyle:arguments[1].strokeStyle,...q})}t.strokeText(H,0,0),t.fillText(H,0,0),B+=U.width+v,t.restore(),H==" "&&w.word++,w.letter++}),w.word++,w.letter++,I+=T*c,w.line++})}const Bt=(e,t,s)=>{for(var i=t.split(" "),n=[],r=i[0],o=1;o<i.length;o++){var l=i[o],h=e.measureText(r+" "+l).width;s==null||h<s?r+=" "+l:(n.push(r),r=l)}return n.push(r),n};function Ot({canvas:e,ctx:t},{width:s=1,height:i=1,anchorX:n=0,anchorY:r=0,radius:o=0}){V({canvas:e,ctx:t},arguments[1]),t.beginPath(),t.roundRect(-n*s,-r*i,s,i,o),t.fill(),t.stroke()}function zt({canvas:e,ctx:t},{width:s=1,anchorX:i=0,anchorY:n=0,startAngle:r=0,endAngle:o=Math.PI*2,counterclockwise:l=!1}){V({canvas:e,ctx:t},arguments[1]),t.beginPath(),t.moveTo(0,0),t.arc(-i*s,-n*s,s,r,o,l),t.fill(),t.stroke()}function At({canvas:e,ctx:t},{width:s=1,height:i=1,anchorX:n=.5,anchorY:r=.5,startAngle:o=0,endAngle:l=Math.PI*2,counterclockwise:h=!1}){V({canvas:e,ctx:t},arguments[1]);const c=s/2,v=i/2;t.beginPath(),t.moveTo(0,0),t.ellipse((-n+.5)*c*2,(-r+.5)*v*2,c,v,0,o,l,h),t.fill(),t.stroke()}function Wt({canvas:e,ctx:t,timestamp:s,playing:i,dTimestamp:n},{elements:r=[],alpha:o}){V({canvas:e,ctx:t},arguments[1]),r.filter(l=>l.start<=n&&l.start+l.duration>n).forEach(l=>{if(!we[l.type])return;const h=We(n,l.animations,l.data,l);h.alpha!==void 0&&o!==void 0&&(h.alpha*=o),t.save(),we[l.type]({canvas:e,ctx:t,timestamp:s,dTimestamp:n-l.start,playing:i},h,l.animations),t.restore()})}function Pt({canvas:e,ctx:t},{dx:s=0,dy:i=0}){V({canvas:e,ctx:t},arguments[1]),t.beginPath(),t.moveTo(0,0),t.lineTo(s-arguments[1].x,i-arguments[1].y),t.stroke()}function Ut({canvas:e,ctx:t},{points:s=[],closePath:i}){V({canvas:e,ctx:t},arguments[1]),t.beginPath(),s.forEach((n,r)=>{r==0?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}),i&&t.closePath(),t.stroke()}const we={audio:ue,image:bt,video:kt,text:It,rectangle:Ot,circle:zt,ellipse:At,group:Wt,line:Pt,path:Ut};var Pe=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},a=(e,t,s)=>(Pe(e,t,"read from private field"),s?s.call(e):t.get(e)),g=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},O=(e,t,s,i)=>(Pe(e,t,"write to private field"),i?i.call(e,s):t.set(e,s),s),Dt=(e,t,s,i)=>({set _(n){O(e,t,n,s)},get _(){return a(e,t,i)}}),y=(e,t,s)=>(Pe(e,t,"access private method"),s),S=new Uint8Array(8),X=new DataView(S.buffer),x=e=>[(e%256+256)%256],b=e=>(X.setUint16(0,e,!1),[S[0],S[1]]),Lt=e=>(X.setInt16(0,e,!1),[S[0],S[1]]),it=e=>(X.setUint32(0,e,!1),[S[1],S[2],S[3]]),u=e=>(X.setUint32(0,e,!1),[S[0],S[1],S[2],S[3]]),G=e=>(X.setUint32(0,Math.floor(e/2**32),!1),X.setUint32(4,e,!1),[S[0],S[1],S[2],S[3],S[4],S[5],S[6],S[7]]),Ue=e=>(X.setInt16(0,2**8*e,!1),[S[0],S[1]]),$=e=>(X.setInt32(0,2**16*e,!1),[S[0],S[1],S[2],S[3]]),De=e=>(X.setInt32(0,2**30*e,!1),[S[0],S[1],S[2],S[3]]),R=(e,t=!1)=>{let s=Array(e.length).fill(null).map((i,n)=>e.charCodeAt(n));return t&&s.push(0),s},Z=e=>e&&e[e.length-1],Y=(e,t,s=!0)=>{let i=e*t;return s?Math.round(i):i},at=e=>{let t=e*(Math.PI/180),s=Math.cos(t),i=Math.sin(t);return[s,i,0,-i,s,0,0,0,1]},xt=at(0),nt=e=>[$(e[0]),$(e[1]),De(e[2]),$(e[3]),$(e[4]),De(e[5]),$(e[6]),$(e[7]),De(e[8])],fe=e=>!e||typeof e!="object"?e:Array.isArray(e)?e.map(fe):Object.fromEntries(Object.entries(e).map(([t,s])=>[t,fe(s)])),ae=e=>e>=0&&e<2**32,_=(e,t,s)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:s}),k=(e,t,s,i,n)=>_(e,[x(t),it(s),i??[]],n),Rt=e=>{let t=512;return e.fragmented?_("ftyp",[R("iso5"),u(t),R("iso5"),R("iso6"),R("mp41")]):_("ftyp",[R("isom"),u(t),R("isom"),e.holdsAvc?R("avc1"):[],R("mp41")])},Le=e=>({type:"mdat",largeSize:e}),Ft=e=>({type:"free",size:e}),Ce=(e,t,s=!1)=>_("moov",null,[Ht(t,e),...e.map(i=>Vt(i,t)),s?ps(e):null]),Ht=(e,t)=>{let s=Y(Math.max(0,...t.filter(o=>o.samples.length>0).map(o=>Z(o.samples).timestamp+Z(o.samples).duration)),$e),i=Math.max(...t.map(o=>o.id))+1,n=!ae(e)||!ae(s),r=n?G:u;return k("mvhd",+n,0,[r(e),r(e),u($e),r(s),$(1),Ue(1),Array(10).fill(0),nt(xt),Array(24).fill(0),u(i)])},Vt=(e,t)=>_("trak",null,[$t(e,t),Nt(e,t)]),$t=(e,t)=>{let s=Z(e.samples),i=Y(s?s.timestamp+s.duration:0,$e),n=!ae(t)||!ae(i),r=n?G:u;return k("tkhd",+n,3,[r(t),r(t),u(e.id),u(0),r(i),Array(8).fill(0),b(0),b(0),Ue(e.info.type==="audio"?1:0),b(0),nt(at(e.info.type==="video"?e.info.rotation:0)),$(e.info.type==="video"?e.info.width:0),$(e.info.type==="video"?e.info.height:0)])},Nt=(e,t)=>_("mdia",null,[Xt(e,t),jt(e.info.type==="video"?"vide":"soun"),Yt(e)]),Xt=(e,t)=>{let s=Z(e.samples),i=Y(s?s.timestamp+s.duration:0,e.timescale),n=!ae(t)||!ae(i),r=n?G:u;return k("mdhd",+n,0,[r(t),r(t),u(e.timescale),r(i),b(21956),b(0)])},jt=e=>k("hdlr",0,0,[R("mhlr"),R(e),u(0),u(0),u(0),R("mp4-muxer-hdlr",!0)]),Yt=e=>_("minf",null,[e.info.type==="video"?qt():Qt(),Gt(),Kt(e)]),qt=()=>k("vmhd",0,1,[b(0),b(0),b(0),b(0)]),Qt=()=>k("smhd",0,0,[b(0),b(0)]),Gt=()=>_("dinf",null,[Zt()]),Zt=()=>k("dref",0,0,[u(1)],[Jt()]),Jt=()=>k("url ",0,1),Kt=e=>_("stbl",null,[es(e),hs(e),us(e),ds(e),fs(e),cs(e)]),es=e=>k("stsd",0,0,[u(1)],[e.info.type==="video"?ts(Ms[e.info.codec],e):rs(Es[e.info.codec],e)]),ts=(e,t)=>_(e,[Array(6).fill(0),b(1),b(0),b(0),Array(12).fill(0),b(t.info.width),b(t.info.height),u(4718592),u(4718592),u(0),b(1),Array(32).fill(0),b(24),Lt(65535)],[ks[t.info.codec](t)]),ss=e=>e.codecPrivate&&_("avcC",[...e.codecPrivate]),is=e=>e.codecPrivate&&_("hvcC",[...e.codecPrivate]),as=e=>e.codecPrivate&&_("vpcC",[...e.codecPrivate]),ns=e=>e.codecPrivate&&_("av1C",[...e.codecPrivate]),rs=(e,t)=>_(e,[Array(6).fill(0),b(1),b(0),b(0),u(0),b(t.info.numberOfChannels),b(16),b(0),b(0),$(t.info.sampleRate)],[_s[t.info.codec](t)]),os=e=>k("esds",0,0,[u(58753152),x(32+e.codecPrivate.byteLength),b(1),x(0),u(75530368),x(18+e.codecPrivate.byteLength),x(64),x(21),it(0),u(130071),u(130071),u(92307584),x(e.codecPrivate.byteLength),...e.codecPrivate,u(109084800),x(1),x(2)]),ls=e=>_("dOps",[x(0),x(e.info.numberOfChannels),b(3840),u(e.info.sampleRate),Ue(0),x(0)]),hs=e=>k("stts",0,0,[u(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[u(t.sampleCount),u(t.sampleDelta)])]),us=e=>{if(e.samples.every(s=>s.type==="key"))return null;let t=[...e.samples.entries()].filter(([,s])=>s.type==="key");return k("stss",0,0,[u(t.length),t.map(([s])=>u(s+1))])},ds=e=>k("stsc",0,0,[u(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[u(t.firstChunk),u(t.samplesPerChunk),u(1)])]),fs=e=>k("stsz",0,0,[u(0),u(e.samples.length),e.samples.map(t=>u(t.size))]),cs=e=>e.finalizedChunks.length>0&&Z(e.finalizedChunks).offset>=2**32?k("co64",0,0,[u(e.finalizedChunks.length),e.finalizedChunks.map(t=>G(t.offset))]):k("stco",0,0,[u(e.finalizedChunks.length),e.finalizedChunks.map(t=>u(t.offset))]),ps=e=>_("mvex",null,e.map(ms)),ms=e=>k("trex",0,0,[u(e.id),u(1),u(0),u(0),u(0)]),rt=(e,t)=>_("moof",null,[gs(e),...t.map(vs)]),gs=e=>k("mfhd",0,0,[u(e)]),ot=e=>{let t=0,s=0,i=0,n=0,r=e.type==="delta";return s|=+r,r?t|=1:t|=2,t<<24|s<<16|i<<8|n},vs=e=>_("traf",null,[ys(e),ws(e),Cs(e)]),ys=e=>{let t=0;t|=8,t|=16,t|=32,t|=131072;let s=e.currentChunk.samples[1]??e.currentChunk.samples[0],i={duration:s.timescaleUnitsToNextSample,size:s.size,flags:ot(s)};return k("tfhd",0,t,[u(e.id),u(i.duration),u(i.size),u(i.flags)])},ws=e=>k("tfdt",1,0,[G(Y(e.currentChunk.startTimestamp,e.timescale))]),Cs=e=>{let t=e.currentChunk.samples.map(M=>M.timescaleUnitsToNextSample),s=e.currentChunk.samples.map(M=>M.size),i=e.currentChunk.samples.map(ot),n=new Set(t),r=new Set(s),o=new Set(i),l=o.size===2&&i[0]!==i[1],h=n.size>1,c=r.size>1,v=!l&&o.size>1,d=0;return d|=1,d|=4*+l,d|=256*+h,d|=512*+c,d|=1024*+v,k("trun",0,d,[u(e.currentChunk.samples.length),u(e.currentChunk.offset-e.currentChunk.moofOffset||0),l?u(i[0]):[],e.currentChunk.samples.map((M,m)=>[h?u(t[m]):[],c?u(s[m]):[],v?u(i[m]):[]])])},Ss=e=>_("mfra",null,[...e.map(Ts),bs()]),Ts=(e,t)=>k("tfra",1,0,[u(e.id),u(63),u(e.finalizedChunks.length),e.finalizedChunks.map(i=>[G(Y(i.startTimestamp,e.timescale)),G(i.moofOffset),u(t+1),u(1),u(1)])]),bs=()=>k("mfro",0,0,[u(0)]),Ms={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},ks={avc:ss,hevc:is,vp9:as,av1:ns},Es={aac:"mp4a",opus:"Opus"},_s={aac:os,opus:ls},lt=class{constructor(){this.buffer=null}},ht=class{constructor(e){this.options=e}},Is=class{constructor(e,t){this.stream=e,this.options=t}},J,ne,xe=class{constructor(){this.pos=0,g(this,J,new Uint8Array(8)),g(this,ne,new DataView(a(this,J).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){a(this,ne).setUint32(0,e,!1),this.write(a(this,J).subarray(0,4))}writeU64(e){a(this,ne).setUint32(0,Math.floor(e/2**32),!1),a(this,ne).setUint32(4,e,!1),this.write(a(this,J).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)a(this,ne).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(a(this,J));e.length%8!==0&&this.write(a(this,J).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let t=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let n of e.children)n&&this.writeBox(n);let s=this.pos,i=e.size??s-t;this.seek(t),this.writeBoxHeader(e,i),this.seek(s)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let s of e.children)s&&(t+=this.measureBox(s));return t}}};J=new WeakMap,ne=new WeakMap;var Se,K,ce,pe,Te,Re,Bs=class extends xe{constructor(e){super(),g(this,Te),g(this,Se,void 0),g(this,K,new ArrayBuffer(2**16)),g(this,ce,new Uint8Array(a(this,K))),g(this,pe,0),O(this,Se,e)}write(e){y(this,Te,Re).call(this,this.pos+e.byteLength),a(this,ce).set(e,this.pos),this.pos+=e.byteLength,O(this,pe,Math.max(a(this,pe),this.pos))}finalize(){y(this,Te,Re).call(this,this.pos),a(this,Se).buffer=a(this,K).slice(0,Math.max(a(this,pe),this.pos))}};Se=new WeakMap,K=new WeakMap,ce=new WeakMap,pe=new WeakMap,Te=new WeakSet,Re=function(e){let t=a(this,K).byteLength;for(;t<e;)t*=2;if(t===a(this,K).byteLength)return;let s=new ArrayBuffer(t),i=new Uint8Array(s);i.set(a(this,ce),0),O(this,K,s),O(this,ce,i)};var be,ee,ut=class extends xe{constructor(e){super(),g(this,be,void 0),g(this,ee,[]),O(this,be,e)}write(e){a(this,ee).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){var s,i;if(a(this,ee).length===0)return;let e=[],t=[...a(this,ee)].sort((n,r)=>n.start-r.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let n=1;n<t.length;n++){let r=e[e.length-1],o=t[n];o.start<=r.start+r.size?r.size=Math.max(r.size,o.start+o.data.byteLength-r.start):e.push({start:o.start,size:o.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let r of a(this,ee))n.start<=r.start&&r.start<n.start+n.size&&n.data.set(r.data,r.start-n.start);(i=(s=a(this,be).options).onData)==null||i.call(s,n.data,n.start)}a(this,ee).length=0}finalize(){}};be=new WeakMap,ee=new WeakMap;var Os=2**24,zs=2,Me,F,D,ke,Fe,He,dt,Ve,ft,me,Ee,ct=class extends xe{constructor(e){var t;if(super(),g(this,ke),g(this,He),g(this,Ve),g(this,me),g(this,Me,void 0),g(this,F,void 0),g(this,D,[]),O(this,Me,e),O(this,F,((t=e.options)==null?void 0:t.chunkSize)??Os),!Number.isInteger(a(this,F))||a(this,F)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){y(this,ke,Fe).call(this,e,this.pos),y(this,me,Ee).call(this),this.pos+=e.byteLength}finalize(){y(this,me,Ee).call(this,!0)}};Me=new WeakMap,F=new WeakMap,D=new WeakMap,ke=new WeakSet,Fe=function(e,t){let s=a(this,D).findIndex(l=>l.start<=t&&t<l.start+a(this,F));s===-1&&(s=y(this,Ve,ft).call(this,t));let i=a(this,D)[s],n=t-i.start,r=e.subarray(0,Math.min(a(this,F)-n,e.byteLength));i.data.set(r,n);let o={start:n,end:n+r.byteLength};if(y(this,He,dt).call(this,i,o),i.written[0].start===0&&i.written[0].end===a(this,F)&&(i.shouldFlush=!0),a(this,D).length>zs){for(let l=0;l<a(this,D).length-1;l++)a(this,D)[l].shouldFlush=!0;y(this,me,Ee).call(this)}r.byteLength<e.byteLength&&y(this,ke,Fe).call(this,e.subarray(r.byteLength),t+r.byteLength)},He=new WeakSet,dt=function(e,t){let s=0,i=e.written.length-1,n=-1;for(;s<=i;){let r=Math.floor(s+(i-s+1)/2);e.written[r].start<=t.start?(s=r+1,n=r):i=r-1}for(e.written.splice(n+1,0,t),(n===-1||e.written[n].end<t.start)&&n++;n<e.written.length-1&&e.written[n].end>=e.written[n+1].start;)e.written[n].end=Math.max(e.written[n].end,e.written[n+1].end),e.written.splice(n+1,1)},Ve=new WeakSet,ft=function(e){let s={start:Math.floor(e/a(this,F))*a(this,F),data:new Uint8Array(a(this,F)),written:[],shouldFlush:!1};return a(this,D).push(s),a(this,D).sort((i,n)=>i.start-n.start),a(this,D).indexOf(s)},me=new WeakSet,Ee=function(e=!1){var t,s;for(let i=0;i<a(this,D).length;i++){let n=a(this,D)[i];if(!(!n.shouldFlush&&!e)){for(let r of n.written)(s=(t=a(this,Me).options).onData)==null||s.call(t,n.data.subarray(r.start,r.end),n.start+r.start);a(this,D).splice(i--,1)}}};var As=class extends ct{constructor(e){var t;super(new ht({onData:(s,i)=>e.stream.write({type:"write",data:s,position:i}),chunkSize:(t=e.options)==null?void 0:t.chunkSize}))}},$e=1e3,Ws=["avc","hevc","vp9","av1"],Ps=["aac","opus"],Us=2082844800,Ds=["strict","offset"],p,f,_e,L,A,W,re,oe,Ne,te,se,ge,Xe,pt,je,mt,Ye,gt,qe,vt,Qe,yt,Ie,Ge,N,j,Ze,wt,ve,Be,Oe,Je,le,ye,ze,Ke,Ls=class{constructor(e){var t;if(g(this,Xe),g(this,je),g(this,Ye),g(this,qe),g(this,Qe),g(this,Ie),g(this,N),g(this,Ze),g(this,ve),g(this,Oe),g(this,le),g(this,ze),g(this,p,void 0),g(this,f,void 0),g(this,_e,void 0),g(this,L,void 0),g(this,A,null),g(this,W,null),g(this,re,Math.floor(Date.now()/1e3)+Us),g(this,oe,[]),g(this,Ne,1),g(this,te,[]),g(this,se,[]),g(this,ge,!1),y(this,Xe,pt).call(this,e),e.video=fe(e.video),e.audio=fe(e.audio),e.fastStart=fe(e.fastStart),this.target=e.target,O(this,p,{firstTimestampBehavior:"strict",...e}),e.target instanceof lt)O(this,f,new Bs(e.target));else if(e.target instanceof ht)O(this,f,(t=e.target.options)!=null&&t.chunked?new ct(e.target):new ut(e.target));else if(e.target instanceof Is)O(this,f,new As(e.target));else throw new Error(`Invalid target: ${e.target}`);y(this,qe,vt).call(this),y(this,je,mt).call(this)}addVideoChunk(e,t,s){let i=new Uint8Array(e.byteLength);e.copyTo(i),this.addVideoChunkRaw(i,e.type,s??e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,s,i,n){if(y(this,ze,Ke).call(this),!a(this,p).video)throw new Error("No video track declared.");if(typeof a(this,p).fastStart=="object"&&a(this,A).samples.length===a(this,p).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${a(this,p).fastStart.expectedVideoChunks}).`);let r=y(this,Ie,Ge).call(this,a(this,A),e,t,s,i,n);if(a(this,p).fastStart==="fragmented"&&a(this,W)){for(;a(this,se).length>0&&a(this,se)[0].timestamp<=r.timestamp;){let o=a(this,se).shift();y(this,N,j).call(this,a(this,W),o)}r.timestamp<=a(this,W).lastTimestamp?y(this,N,j).call(this,a(this,A),r):a(this,te).push(r)}else y(this,N,j).call(this,a(this,A),r)}addAudioChunk(e,t,s){let i=new Uint8Array(e.byteLength);e.copyTo(i),this.addAudioChunkRaw(i,e.type,s??e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,s,i,n){if(y(this,ze,Ke).call(this),!a(this,p).audio)throw new Error("No audio track declared.");if(typeof a(this,p).fastStart=="object"&&a(this,W).samples.length===a(this,p).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${a(this,p).fastStart.expectedAudioChunks}).`);let r=y(this,Ie,Ge).call(this,a(this,W),e,t,s,i,n);if(a(this,p).fastStart==="fragmented"&&a(this,A)){for(;a(this,te).length>0&&a(this,te)[0].timestamp<=r.timestamp;){let o=a(this,te).shift();y(this,N,j).call(this,a(this,A),o)}r.timestamp<=a(this,A).lastTimestamp?y(this,N,j).call(this,a(this,W),r):a(this,se).push(r)}else y(this,N,j).call(this,a(this,W),r)}finalize(){if(a(this,ge))throw new Error("Cannot finalize a muxer more than once.");if(a(this,p).fastStart==="fragmented"){for(let t of a(this,te))y(this,N,j).call(this,a(this,A),t);for(let t of a(this,se))y(this,N,j).call(this,a(this,W),t);y(this,Oe,Je).call(this,!1)}else a(this,A)&&y(this,ve,Be).call(this,a(this,A)),a(this,W)&&y(this,ve,Be).call(this,a(this,W));let e=[a(this,A),a(this,W)].filter(Boolean);if(a(this,p).fastStart==="in-memory"){let t;for(let i=0;i<2;i++){let n=Ce(e,a(this,re)),r=a(this,f).measureBox(n);t=a(this,f).measureBox(a(this,L));let o=a(this,f).pos+r+t;for(let l of a(this,oe)){l.offset=o;for(let{data:h}of l.samples)o+=h.byteLength,t+=h.byteLength}if(o<2**32)break;t>=2**32&&(a(this,L).largeSize=!0)}let s=Ce(e,a(this,re));a(this,f).writeBox(s),a(this,L).size=t,a(this,f).writeBox(a(this,L));for(let i of a(this,oe))for(let n of i.samples)a(this,f).write(n.data),n.data=null}else if(a(this,p).fastStart==="fragmented"){let t=a(this,f).pos,s=Ss(e);a(this,f).writeBox(s);let i=a(this,f).pos-t;a(this,f).seek(a(this,f).pos-4),a(this,f).writeU32(i)}else{let t=a(this,f).offsets.get(a(this,L)),s=a(this,f).pos-t;a(this,L).size=s,a(this,L).largeSize=s>=2**32,a(this,f).patchBox(a(this,L));let i=Ce(e,a(this,re));if(typeof a(this,p).fastStart=="object"){a(this,f).seek(a(this,_e)),a(this,f).writeBox(i);let n=t-a(this,f).pos;a(this,f).writeBox(Ft(n))}else a(this,f).writeBox(i)}y(this,le,ye).call(this),a(this,f).finalize(),O(this,ge,!0)}};p=new WeakMap,f=new WeakMap,_e=new WeakMap,L=new WeakMap,A=new WeakMap,W=new WeakMap,re=new WeakMap,oe=new WeakMap,Ne=new WeakMap,te=new WeakMap,se=new WeakMap,ge=new WeakMap,Xe=new WeakSet,pt=function(e){if(e.video){if(!Ws.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.video.rotation!==void 0&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!Ps.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!Ds.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")},je=new WeakSet,mt=function(){var e;if(a(this,f).writeBox(Rt({holdsAvc:((e=a(this,p).video)==null?void 0:e.codec)==="avc",fragmented:a(this,p).fastStart==="fragmented"})),O(this,_e,a(this,f).pos),a(this,p).fastStart==="in-memory")O(this,L,Le(!1));else if(a(this,p).fastStart!=="fragmented"){if(typeof a(this,p).fastStart=="object"){let t=y(this,Ye,gt).call(this);a(this,f).seek(a(this,f).pos+t)}O(this,L,Le(!0)),a(this,f).writeBox(a(this,L))}y(this,le,ye).call(this)},Ye=new WeakSet,gt=function(){if(typeof a(this,p).fastStart!="object")return;let e=0,t=[a(this,p).fastStart.expectedVideoChunks,a(this,p).fastStart.expectedAudioChunks];for(let s of t)s&&(e+=8*Math.ceil(2/3*s),e+=4*s,e+=12*Math.ceil(2/3*s),e+=4*s,e+=8*s);return e+=4096,e},qe=new WeakSet,vt=function(){if(a(this,p).video&&O(this,A,{id:1,info:{type:"video",codec:a(this,p).video.codec,width:a(this,p).video.width,height:a(this,p).video.height,rotation:a(this,p).video.rotation??0},timescale:11520,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),a(this,p).audio){let e=y(this,Qe,yt).call(this,2,a(this,p).audio.sampleRate,a(this,p).audio.numberOfChannels);O(this,W,{id:a(this,p).video?2:1,info:{type:"audio",codec:a(this,p).audio.codec,numberOfChannels:a(this,p).audio.numberOfChannels,sampleRate:a(this,p).audio.sampleRate},timescale:a(this,p).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}},Qe=new WeakSet,yt=function(e,t,s){let n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),r=s,o="";o+=e.toString(2).padStart(5,"0"),o+=n.toString(2).padStart(4,"0"),n===15&&(o+=t.toString(2).padStart(24,"0")),o+=r.toString(2).padStart(4,"0");let l=Math.ceil(o.length/8)*8;o=o.padEnd(l,"0");let h=new Uint8Array(o.length/8);for(let c=0;c<o.length;c+=8)h[c/8]=parseInt(o.slice(c,c+8),2);return h},Ie=new WeakSet,Ge=function(e,t,s,i,n,r){var c;let o=i/1e6,l=n/1e6;return o=y(this,Ze,wt).call(this,o,e),(c=r==null?void 0:r.decoderConfig)!=null&&c.description&&(e.codecPrivate=new Uint8Array(r.decoderConfig.description)),{timestamp:o,duration:l,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:Y(l,e.timescale)}},N=new WeakSet,j=function(e,t){if(a(this,p).fastStart!=="fragmented"&&e.samples.push(t),e.lastTimescaleUnits!==null){let i=Y(t.timestamp,e.timescale,!1),n=Math.round(i-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=n,e.lastSample.timescaleUnitsToNextSample=n,a(this,p).fastStart!=="fragmented"){let r=Z(e.timeToSampleTable);r.sampleCount===1?(r.sampleDelta=n,r.sampleCount++):r.sampleDelta===n?r.sampleCount++:(r.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:n}))}}else e.lastTimescaleUnits=0,a(this,p).fastStart!=="fragmented"&&e.timeToSampleTable.push({sampleCount:1,sampleDelta:Y(t.duration,e.timescale)});e.lastSample=t;let s=!1;if(!e.currentChunk)s=!0;else{let i=t.timestamp-e.currentChunk.startTimestamp;if(a(this,p).fastStart==="fragmented"){let n=a(this,A)??a(this,W);e===n&&t.type==="key"&&i>=1&&(s=!0,y(this,Oe,Je).call(this))}else s=i>=.5}s&&(e.currentChunk&&y(this,ve,Be).call(this,e),e.currentChunk={startTimestamp:t.timestamp,samples:[]}),e.currentChunk.samples.push(t)},Ze=new WeakSet,wt=function(e,t){if(a(this,p).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(a(this,p).firstTimestampBehavior==="offset"&&(t.firstTimestamp===void 0&&(t.firstTimestamp=e),e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return t.lastTimestamp=e,e},ve=new WeakSet,Be=function(e){if(a(this,p).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),a(this,oe).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||Z(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),a(this,p).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=a(this,f).pos;for(let t of e.currentChunk.samples)a(this,f).write(t.data),t.data=null;y(this,le,ye).call(this)}},Oe=new WeakSet,Je=function(e=!0){if(a(this,p).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let t=[a(this,A),a(this,W)].filter(l=>l&&l.currentChunk);if(t.length===0)return;let s=Dt(this,Ne)._++;if(s===1){let l=Ce(t,a(this,re),!0);a(this,f).writeBox(l)}let i=a(this,f).pos,n=rt(s,t);a(this,f).writeBox(n);{let l=Le(!1),h=0;for(let v of t)for(let d of v.currentChunk.samples)h+=d.size;let c=a(this,f).measureBox(l)+h;c>=2**32&&(l.largeSize=!0,c=a(this,f).measureBox(l)+h),l.size=c,a(this,f).writeBox(l)}for(let l of t){l.currentChunk.offset=a(this,f).pos,l.currentChunk.moofOffset=i;for(let h of l.currentChunk.samples)a(this,f).write(h.data),h.data=null}let r=a(this,f).pos;a(this,f).seek(a(this,f).offsets.get(n));let o=rt(s,t);a(this,f).writeBox(o),a(this,f).seek(r);for(let l of t)l.finalizedChunks.push(l.currentChunk),a(this,oe).push(l.currentChunk),l.currentChunk=null;e&&y(this,le,ye).call(this)},le=new WeakSet,ye=function(){a(this,f)instanceof ut&&a(this,f).flush()},ze=new WeakSet,Ke=function(){if(a(this,ge))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};const Ct=[],St=e=>{e<=0&&(e=0),e=Math.round(e/1e3);const t=Math.floor(e/60),s=e-t*60;return`${t}:${s>9?"":"0"}${s}`};class xs{constructor(t){this.canvas=null,this.ctx=null,this.data=null,this.timestamp=0,this.playing=!0,this.loop=!0,this.events=[],this.saves={},this.audioContext=new AudioContext,this.audioStream=this.audioContext.createMediaStreamDestination(),this.audios=[],this.corsURL=s=>s,this.update(),Object.assign(this,t),window.render=this}setElement(t){this.setCanvas(),t&&(t.appendChild(this.canvas),this.setControls(t))}setCanvas(t){this.canvas=t||document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{desynchronized:!0}),this.canvas.style.width="100%",this.canvas.style.height="100%"}setControls(t){t.style.position="relative";const s=document.createElement("div");s.style.position="absolute",s.style.display="flex",s.style.justifyContent="flex-end",s.style.flexDirection="column",s.style.gap="5px",s.style.width="100%",s.style.height="100%",s.style.bottom=0,s.style.left=0,s.style.color="white",s.style.padding="10px",s.style.boxSizing="border-box",s.style.background="linear-gradient(180deg, rgba(0,0,0,0) 80%, rgba(0,0,0,1) 100%)",s.addEventListener("click",M=>this.playing=!this.playing),s.style.transition="opacity 200ms ease-in-out 0ms",s.style.opacity=0,s.addEventListener("mouseover",()=>s.style.opacity=100),s.addEventListener("mouseout",()=>s.style.opacity=0),t.style.fontFamily='ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"',t.appendChild(s);const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="space-between",s.appendChild(i);const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="5px",i.appendChild(n);const r=document.createElement("div");r.style.display="flex",i.appendChild(r);const o=document.createElement("div");o.style.padding="10px",o.style.marginLeft="-5px",o.style.marginBottom="-10px",o.style.cursor="pointer",o.appendChild(document.createElement("svg")),o.addEventListener("click",()=>this.playing=!this.playing),n.appendChild(o);const l=document.createElement("div");l.style.userSelect="none",l.style.marginBottom="-10px",l.style.fontSize="15px",n.appendChild(l);const h=document.createElement("div");h.style.padding="10px",h.style.marginRight="-5px",h.style.marginBottom="-10px",h.innerHTML='<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15 9h4l-7 7-7-7h4V3h6v6ZM5 20v-2h14v2H5Z" clip-rule="evenodd"></path></svg>',h.style.cursor="pointer",h.addEventListener("click",()=>this.exportMP4()),r.appendChild(h);const c=document.createElement("div");c.style.height="5px",c.style.width="100%",c.style.backgroundColor="rgb(150, 150, 150)",c.style.borderRadius="10px",c.style.overflow="hidden";const v=M=>{const m=M.currentTarget.getBoundingClientRect(),w=M.clientX-m.left;this.setTimestamp(w/M.currentTarget.offsetWidth*this.duration)};c.addEventListener("pointerdown",M=>{M.preventDefault(),c.pointerisdown=!0,c.playing=this.playing,this.playing=!1,v(M)}),document.addEventListener("pointerup",M=>{c.pointerisdown&&(c.pointerisdown=!1,this.playing=c.playing)}),c.addEventListener("pointermove",M=>{M.preventDefault(),c.pointerisdown&&v(M)});const d=document.createElement("div");d.style.height="100%",d.style.width="50%",d.style.backgroundColor="rgb(255, 255, 255)",d.style.pointerEvents="none",c.appendChild(d),s.appendChild(c),this.UI={play:o,timer:l,download:h,controls:s,parent:t,progress:c,progressBar:d}}updateUI(){this.UI&&this.data&&(this.UI.timer.innerText=`${St(this.timestamp)} / ${St(this.duration)}`,this.UI.progressBar.style.width=`${this.timestamp/this.duration*100}%`,this.rendering?this.UI.parent.style.filter="grayscale() blur(5px)":this.UI.parent.style.filter="",this.playing?this.UI.play.firstChild.innerHTML='<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7L8 5Z"></path></svg>':this.UI.play.firstChild.innerHTML='<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 19H6V5h4v14Zm4 0V5h4v14h-4Z" clip-rule="evenodd"></path></svg>')}export(){return new Promise(async(t,s)=>{let i=this.playing;this.playing=!1;try{const n=this.getFlattenElements(this.data).filter(v=>["audio","video"].includes(v.type)),r=n.length>0;let o=new Ls({target:new lt,video:{codec:"avc",width:this.canvas.width,height:this.canvas.height},audio:r?{codec:"opus",numberOfChannels:2,sampleRate:44100}:null,firstTimestampBehavior:"offset",fastStart:"in-memory"});if(r)try{let v=new AudioEncoder({output:(m,w)=>o.addAudioChunk(m,w),error:m=>console.error(m)});v.configure({codec:"opus",sampleRate:44100,numberOfChannels:2,bitrate:128e3});const d=[],M=new AudioContext;for(let m of n)try{const z=await(await fetch(m.data.src)).arrayBuffer(),T=new AudioContext,I=await T.decodeAudioData(z),C=(m.start||0)/1e3,E=(m.duration||0)/1e3,B=(m.data.trim||0)/1e3,H=Math.round(C*I.sampleRate),U=Math.round(E*I.sampleRate),ie=Math.round(B*I.sampleRate),he=Math.min(ie,U),Ae=T.createBuffer(I.numberOfChannels,H+U-he,I.sampleRate);for(let q=0;q<I.numberOfChannels;q++){const Q=I.getChannelData(q);Ae.getChannelData(q).set(Q.slice(he,he+U-he),H)}d.push(Ae)}catch{}if(d.length>0){const m=d[0].sampleRate,w=d[0].numberOfChannels,z=Math.round(this.duration/1e3*m),T=M.createBuffer(w,z,m);for(let E=0;E<z;E++)for(let B=0;B<w;B++){let H=0;for(let U=0;U<d.length;U++){const ie=d[U];E<ie.length&&(H+=ie.getChannelData(B)[E])}T.getChannelData(B)[E]=H}const I=new Float32Array(T.length*w);for(let E=0;E<w;E++){const B=T.getChannelData(E);I.set(B,E*T.length)}const C=new AudioData({format:"f32-planar",sampleRate:T.sampleRate,numberOfFrames:T.length,numberOfChannels:w,timestamp:0,data:I});v.encode(C),await v.flush()}}catch{}let l=new VideoEncoder({output:(v,d)=>o.addVideoChunk(v,d),error:v=>console.error(v)});l.configure({avc:{format:"avc"},codec:"avc1.640034",width:this.canvas.width,height:this.canvas.height,bitrate:5e6});const h=1e3/this.data.settings.fps*1||30;this.rendering=!0;for(let v=0;v<=Math.floor(this.duration/h);v++){v%10==0&&await new Promise(M=>setTimeout(M,0)),this.emit("rendering",{progress:v*h/this.duration}),await this.setTimestamp(v*h);const d=new VideoFrame(this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data.buffer,{format:"RGBA",codedWidth:this.canvas.width,codedHeight:this.canvas.height,timestamp:v*h*1e3,duration:h});l.encode(d)}this.rendering=!1,await l.flush(),o.finalize();let{buffer:c}=o.target;t(new Blob([c],{type:"video/mp4"}))}catch(n){s(n)}this.playing=i})}exportPNG(t="image/png",s="1"){return new Promise(i=>this.canvas.toBlob(n=>i(n),t,s))}exportMP4(t="smooth-video.mp4"){this.export().then(s=>{const i=document.createElement("a");i.href=URL.createObjectURL(s),i.download=t,i.click()})}stop(){this.stopMedia(),this.playing=!1,this.stopped=!0}get duration(){return!this.data||!this.data.elements||this.data.elements.length==0?0:Math.max(...this.data.elements.map(t=>t.start+t.duration))||0}on(t){this.events.push(t)}emit(t,s){this.events.forEach(i=>i(t,s))}async setTimestamp(t){this.timestamp=t,await this.render()}resetMedia(){this.getFlattenElements(this.data).filter(t=>["video","audio"].includes(t.type)).filter(t=>t.start>this.timestamp||t.start+t.duration<this.timestamp).forEach(t=>{t.data.element&&(t.data.element.volume=0)})}stopMedia(){this.getFlattenElements(this.data).filter(t=>["video","audio"].includes(t.type)).forEach(t=>{var s,i;return(i=(s=t.data)==null?void 0:s.element)==null?void 0:i.pause()})}set(t){return new Promise(async(s,i)=>{if(!t)return i();const n=t;if(!n)return i();try{await this.load(n),this.data=n,this.render(),s()}catch{i()}})}load(t){return new Promise(s=>Promise.allSettled(this.getFlattenElements(t).map(i=>this.loadElement(i))).then(s))}getFlattenElements(t){if(!t||!t.elements)return[];let s=[...t.elements],i=[];for(;s.length>0;){const n=s[0];i.push(n),s.shift(),n.data.elements&&(s=[...s,...n.data.elements.map(r=>({...r,start:r.start+n.start}))])}return i}loadElement(t){return new Promise((s,i)=>{if(this.saves[t.data.src])return t.data.element=this.saves[t.data.src],s();switch(t.type){case"text":this.loadFont(t.data.font).then(()=>s());break;case"image":this.loadImage(t.data.src).then(n=>{t.data.element=n,this.saves[t.data.src]=n}).finally(s);break;case"video":if(t.data.element)return s();this.loadVideo(t.data.src).then(n=>{t.data.element=n,this.saves[t.data.src]=n;const r=this.audioContext.createMediaElementSource(n);r.connect(this.audioContext.destination),this.audios.push(r)}).finally(s);break;case"audio":this.loadAudio(t.data.src).then(n=>{t.data.element=n,this.saves[t.data.src]=n;const r=this.audioContext.createMediaElementSource(n);r.connect(this.audioContext.destination),this.audios.push(r)}).finally(s);break;default:s()}})}loadFont(t){return new Promise(s=>{if(!t||typeof t!="string")return s();const i=t.replace(/[0-9.-:\/]*/gm,"");if(!Ct.includes(i))new FontFace(i,`url(${t})`).load().then(n=>{document.fonts.add(n),Ct.push(i)}).finally(s);else return s()})}loadImage(t,s){return new Promise((i,n)=>{const r=new Image;r.src=t,r.crossOrigin="anonymous",r.addEventListener("load",()=>i(r)),r.addEventListener("error",()=>{s?n():this.loadImage(this.corsURL(t),!0).then(i).catch(n)})})}loadVideo(t,s){return new Promise((i,n)=>{const r=document.createElement("video");r.src=t,r.crossOrigin="anonymous",r.addEventListener("loadeddata",()=>i(r)),r.addEventListener("error",()=>{s?n():this.loadVideo(this.corsURL(t),!0).then(i).catch(n)})})}loadAudio(t,s){return new Promise((i,n)=>{const r=document.createElement("audio");r.src=t,r.crossOrigin="anonymous",r.addEventListener("loadeddata",()=>i(r)),s||r.addEventListener("error",()=>this.loadAudio(this.corsURL(t),!0).then(o=>i(o)))})}update(){if(this.stopped||(requestAnimationFrame(()=>this.update()),this.rendering))return;this.audioContext.state=="suspended"&&window.hasEventDone&&this.audioContext.resume();const t=Date.now();this.tick||(this.tick=t),this.playing&&(this.timestamp+=t-this.tick),this.timestamp>this.duration&&(this.loop?this.setTimestamp(0):(this.playing=!1,this.setTimestamp(this.duration))),this.resetMedia(),this.render(),this.tick=t}resize(){this.canvas.height=Math.ceil(this.data.settings.height*1),this.canvas.width=Math.ceil(this.data.settings.width*1)}async render(){if(!this.canvas||!this.ctx||!this.data)return;this.updateUI(),this.emit("render",{progress:this.timestamp/this.duration,timestamp:this.timestamp,duration:this.duration}),this.resize(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.fillStyle=this.data.settings.color||"#ffffff",this.ctx.fillRect(0,0,this.data.settings.width,this.data.settings.height);const t=this.data.elements.filter(s=>s.start<=this.timestamp&&s.start+s.duration>this.timestamp);for(let s of t)await this.renderElement(s);this.ctx.restore()}async renderElement(t){if(!we[t.type])return;const s=this.getElementData(t);this.ctx.save(),await we[t.type]({canvas:this.canvas,ctx:this.ctx,timestamp:this.timestamp,dTimestamp:this.timestamp-t.start,playing:this.playing,rendering:this.rendering},s,t.animations),this.ctx.restore()}getElementData(t){var s;return We(this.timestamp,(s=t.animations)==null?void 0:s.filter(i=>!i.type),t.data,t)}}return xs});
